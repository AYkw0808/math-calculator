<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數學計算工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, "Microsoft JhengHei", sans-serif;
        }
        body {
            background-color: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .function-list {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .function-list h2 {
            margin-bottom: 15px;
            color: #444;
        }
        .function-list ul {
            list-style: none;
            columns: 2;
            gap: 10px;
        }
        .function-list li {
            padding: 5px 0;
            cursor: pointer;
            transition: color 0.2s;
        }
        .function-list li:hover {
            color: #007bff;
        }
        .input-form {
            display: none;
            margin-bottom: 20px;
        }
        .input-form.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .result-area {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: "Courier New", monospace;
            max-height: 500px;
            overflow-y: auto;
        }
        .error {
            color: #dc3545;
        }
        .success {
            color: #000000;
        }
        .back-btn {
            background: #6c757d;
            margin-top: 10px;
        }
        .back-btn:hover {
            background: #5a6268;
        }
        .form-note {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>數學計算工具</h1>

        <!-- 功能列表 -->
        <div class="function-list" id="functionList">
            <h2>選擇計算功能</h2>
            <ul>
                <li data-choice="0">[0] 離開程式</li>
                <li data-choice="1">[1] 二項式展開係數</li>
                <li data-choice="2">[2] e的展開</li>
                <li data-choice="3">[3] 伯努利分布</li>
                <li data-choice="4">[4] 泊松分布</li>
                <li data-choice="5">[5] 二項概率分布</li>
                <li data-choice="6">[6] 常態分布/正態分布</li>
                <li data-choice="7">[7] 直線方程/分點座標/三角形計算</li>
                <li data-choice="8">[8] 圓/拋物線/直線交點</li>
                <li data-choice="9">[9] 不定積分/定積分/梯形法則</li>
                <li data-choice="10">[10] 1-4次函數因式分解/求根</li>
                <li data-choice="11">[11] 進制轉換</li>
                <li data-choice="12">[12] 微分計算</li>
                <li data-choice="13">[13] 函數化簡/代入/合併同類項</li>
                <li data-choice="14">[14] 統計學 E(x) Var(x)</li>
            </ul>
        </div>

        <!-- 0. 離開程式 -->
        <div class="input-form" id="form0">
            <h3>離開程式</h3>
            <p>點擊下方按鈕返回功能列表</p>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 1. 二項式展開 -->
        <div class="input-form" id="form1">
            <h3>二項式展開係數</h3>
            <div class="form-group">
                <label for="A1">A ((A+Bx)^n 中的A):</label>
                <input type="number" id="A1" name="A" step="any" required>
            </div>
            <div class="form-group">
                <label for="B1">B ((A+Bx)^n 中的B):</label>
                <input type="number" id="B1" name="B" step="any" required>
            </div>
            <div class="form-group">
                <label for="n1">次方 n:</label>
                <input type="number" id="n1" name="n" min="1" required>
            </div>
            <button type="button" onclick="submitForm(1)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 2. e的展開 -->
        <div class="input-form" id="form2">
            <h3>e的展開</h3>
            <div class="form-group">
                <label for="k2">次方係數 k (e^(kx)):</label>
                <input type="number" id="k2" name="k" step="any" required>
            </div>
            <div class="form-group">
                <label for="n2">所需展開項數 n:</label>
                <input type="number" id="n2" name="n" min="1" required>
            </div>
            <button type="button" onclick="submitForm(2)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 3. 伯努利分布 -->
        <div class="input-form" id="form3">
            <h3>伯努利分布</h3>
            <div class="form-group">
                <label for="p3">成功概率 p:</label>
                <input type="number" id="p3" name="p" step="any" min="0" max="1" required>
            </div>
            <div class="form-group">
                <label for="k3">成功次數 k (0或1):</label>
                <input type="number" id="k3" name="k" min="0" max="1" required>
            </div>
            <button type="button" onclick="submitForm(3)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 4. 泊松分布 -->
        <div class="input-form" id="form4">
            <h3>泊松分布</h3>
            <div class="form-group">
                <label for="mu4">平均值 λ (mu):</label>
                <input type="number" id="mu4" name="mu" step="any" min="0" required>
            </div>
            <div class="form-group">
                <label for="n4">起始次數 n :</label>
                <input type="number" id="n4" name="n" min="0" required>
            </div>
            <div class="form-group">
                <label for="k4">結束次數 k (若所求發生次數為單次，重複輸入兩次就可以):</label>
                <input type="number" id="k4" name="k" min="0" required>
            </div>
            <button type="button" onclick="submitForm(4)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 5. 二項概率分布 -->
        <div class="input-form" id="form5">
            <h3>二項概率分布</h3>
            <div class="form-group">
                <label for="n5">總試驗次數 n:</label>
                <input type="number" id="n5" name="n" min="1" required>
            </div>
            <div class="form-group">
                <label for="p5">成功概率 p:</label>
                <input type="number" id="p5" name="p" step="any" min="0" max="1" required>
            </div>
            <div class="form-group">
                <label for="k5">所求成功次數 k:</label>
                <input type="number" id="k5" name="k" min="0" required>
            </div>
            <button type="button" onclick="submitForm(5)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 6. 常態分布 -->
        <div class="input-form" id="form6">
            <h3>常態分布/正態分布</h3>
            <div class="form-group">
                <label for="mu6">平均值 µ :</label>
                <input type="number" id="mu6" name="mu" step="any" required>
            </div>
            <div class="form-group">
                <label for="mu_26">標準差 σ :</label>
                <input type="number" id="mu_26" name="mu_2" step="any" min="0.001" required>
            </div>
            <div class="form-group">
                <label for="choices6">計算類型:</label>
                <select id="choices6" name="choices" required onchange="toggleNormalType()">
                    <option value="0">正向計算 (已知區間求概率)</option>
                    <option value="1">反向計算 (已知概率求區間)</option>
                </select>
            </div>
            <div id="normalForward" class="normal-section">
                <div class="form-group">
                    <label for="B6">端點 B:</label>
                    <input type="number" id="B6" name="B" step="any" required>
                </div>
                <div class="form-group">
                    <label for="A6">端點 A:</label>
                    <input type="number" id="A6" name="A" step="any" required>
                </div>
            </div>
            <div id="normalReverse" class="normal-section" style="display:none;">
                <div class="form-group">
                    <label for="p6">已知區間概率 p:</label>
                    <input type="number" id="p6" name="p" step="any" min="0" max="1" required>
                </div>
            </div>
            <button type="button" onclick="submitForm(6)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 7. 直線方程/分點座標/三角形計算 -->
        <div class="input-form" id="form7">
            <h3>直線方程/分點座標/四心計算/外內切圓方程/三角形邊長角度計算</h3>
            <div class="form-group">
                <label for="A_x7">A點的x座標:</label>
                <input type="number" id="A_x7" name="A_x" step="any" required>
            </div>
            <div class="form-group">
                <label for="A_y7">A點的y座標:</label>
                <input type="number" id="A_y7" name="A_y" step="any" required>
            </div>
            <div class="form-group">
                <label for="B_x7">B點的x座標:</label>
                <input type="number" id="B_x7" name="B_x" step="any" required>
            </div>
            <div class="form-group">
                <label for="B_y7">B點的y座標:</label>
                <input type="number" id="B_y7" name="B_y" step="any" required>
            </div>
            <div class="form-group">
                <label for="C_x7">(選填)C點的x座標 (四心計算需填):</label>
                <input type="number" id="C_x7" name="C_x" step="any">
            </div>
            <div class="form-group">
                <label for="C_y7">(選填)C點的y座標 (四心計算需填):</label>
                <input type="number" id="C_y7" name="C_y" step="any">
            </div>
            <div class="form-group">
                <label for="C7">(選填)內分點比例 PA:</label>
                <input type="number" id="C7" name="C" step="any" min="0.001">
            </div>
            <div class="form-group">
                <label for="D7">(選填)內分點比例 PB:</label>
                <input type="number" id="D7" name="D" step="any" min="0.001">
            </div>
            <button type="button" onclick="submitForm(7)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 8. 圓/拋物線/直線交點 -->
        <div class="input-form" id="form8">
            <h3>圓/拋物線/直線與直線交點計算</h3>
            <p><strong>模式說明：</strong></p>
            <p>1. 圓模式：A≠0 → 方程 Ax²+Ay²+Bx+Cy+D=0</p>
            <p>2. 拋物線模式：A=0且B≠0 → 方程 y=Bx²+Cx+D</p>
            <p>3. 直線模式：A=0且B=0 → 方程 Cx+Dy=H</p>
            <p><strong>直線方程：Ex + Fy = G</strong></p>
            <div class="form-group">
                <label for="A8">A (圓方程係數，拋物線/直線請填0)：</label>
                <input type="number" id="A8" name="A" step="any" required oninput="toggleHInput()">
            </div>
            <div class="form-group">
                <label for="B8">B (圓/拋物線係數，直線請填0)：</label>
                <input type="number" id="B8" name="B" step="any" required oninput="toggleHInput()">
            </div>
            <div class="form-group">
                <label for="C8">C (圓/拋物線/直線係數)：</label>
                <input type="number" id="C8" name="C" step="any" required>
            </div>
            <div class="form-group">
                <label for="D8">D (圓/拋物線/直線係數)：</label>
                <input type="number" id="D8" name="D" step="any" required>
            </div>

            <!-- 直线模式专属：H参数（条件显示） -->
            <div class="form-group" id="H8Group" style="display: none;">
                <label for="H8">H (直線模式常數項 Cx+Dy=H)：</label>
                <input type="number" id="H8" name="H" step="any" required>
            </div>


            <!-- 第二组参数：相交的直线方程系数 -->
            <div class="form-group">
                <label for="E8">E (相交直線係數 Ex+Fy=G)：</label>
                <input type="number" id="E8" name="E" step="any" required>
            </div>
            <div class="form-group">
                <label for="F8">F (相交直線係數 Ex+Fy=G)：</label>
                <input type="number" id="F8" name="F" step="any" required>
            </div>
            <div class="form-group">
                <label for="G8">G (相交直線常數項 Ex+Fy=G)：</label>
                <input type="number" id="G8" name="G" step="any" required>
            </div>
            <button type="button" onclick="submitForm(8)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 9. 不定積分/定積分/梯形法則 -->
        <div class="input-form" id="form9">
            <h3>不定積分/定積分/梯形法則</h3>
            <div class="form-group">
                <label for="func9">積分函數 f(x) (使用x作為變量，例如: x**2 + 2*x + 1):</label>
                <textarea id="func9" name="func" rows="2" required>x</textarea>
                <div class="form-note">
                    支援運算符: + - * / ** (次方) 、sin(x) cos(x) exp(x) log(x) 等數學函數
                </div>
            </div>
            <div class="form-group">
                <label for="a9">積分下限 a:</label>
                <input type="number" id="a9" name="a" step="any" required>
            </div>
            <div class="form-group">
                <label for="b9">積分上限 b:</label>
                <input type="number" id="b9" name="b" step="any" required>
            </div>
            <div class="form-group">
                <label for="Choice9">是否使用梯形法則 (y/n):</label>
                <select id="Choice9" name="Choice" onchange="toggleTrapezoidInput()">
                    <option value="n">否</option>
                    <option value="y">是</option>
                </select>
            </div>
            <div id="trapezoidInput" style="display:none;">
                <div class="form-group">
                    <label for="n_trap9">梯形法則子區間數 n:</label>
                    <input type="number" id="n_trap9" name="n_trap" min="1" value="10">
                </div>
            </div>
            <button type="button" onclick="submitForm(9)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 10. 1-4次函數因式分解/求根 -->
        <div class="input-form" id="form10">
            <h3>1-4次函數因式分解/求根</h3>
            <div class="form-group">
                <label for="A_410">A (Ax⁴):</label>
                <input type="number" id="A_410" name="A_4" step="any" >
            </div>
            <div class="form-group">
                <label for="B_310">B (Bx³):</label>
                <input type="number" id="B_310" name="B_3" step="any" >
            </div>
            <div class="form-group">
                <label for="C_210">C (Cx²):</label>
                <input type="number" id="C_210" name="C_2" step="any" >
            </div>
            <div class="form-group">
                <label for="D_110">D (Dx):</label>
                <input type="number" id="D_110" name="D_1" step="any" >
            </div>
            <div class="form-group">
                <label for="E_010">E (常數項):</label>
                <input type="number" id="E_010" name="E_0" step="any" >
            </div>
            <button type="button" onclick="submitForm(10)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 11. 進制轉換 -->
        <div class="input-form" id="form11">
            <h3>進制轉換 (2, 10, 16)</h3>
            <div class="form-group">
                <label for="base11">原始進制:</label>
                <select id="base11" name="base" required>
                    <option value="2">二進制</option>
                    <option value="10">十進制</option>
                    <option value="16">十六進制</option>
                </select>
            </div>
            <div class="form-group">
                <label for="num11">要轉換的數字:</label>
                <input type="text" id="num11" name="num" required>
                <div class="form-note">
                    二進制: 0-1 | 十進制: 0-9 | 十六進制: 0-9, A-F (不分大小寫)
                </div>
            </div>
            <button type="button" onclick="submitForm(11)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 12. 微分計算 -->
        <div class="input-form" id="form12">
            <h3>微分計算</h3>
            <div class="form-group">
                <label for="func12">函數 f(x) (使用x作為變量):</label>
                <textarea id="func12" name="func" rows="2" required>x</textarea>
                <div class="form-note">
                    支援運算符: + - * / ** (次方) 、sin(x) cos(x) exp(x) log(x) 等數學函數
                </div>
            </div>
            <button type="button" onclick="submitForm(12)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 13. 函數化簡/代入/合併同類項 -->
        <div class="input-form" id="form13">
            <h3>函數化簡/代入/合併同類項</h3>
            <div class="form-group">
                <label for="func13">函數 f(x) (使用x作為變量):</label>
                <textarea id="func13" name="func" rows="2" required>x</textarea>
                <div class="form-note">
                    支援運算符: + - * / ** (次方) 、sin(x) cos(x) exp(x) log(x) 等數學函數
                </div>
            </div>
            <div class="form-group">
                <label for="n_sub13">(選填)代入值 x = n:</label>
                <input type="number" id="n_sub13" name="n_sub" step="any">
            </div>
            <button type="button" onclick="submitForm(13)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 14. 統計學 E(x) Var(x) -->
        <div class="input-form" id="form14">
            <h3>統計學 E(x) Var(x)</h3>
            <div class="form-group">
                <label for="data14">數據值 (逗號分隔，例如: 1,2,3,4):</label>
                <input type="text" id="data14" name="data" required>
            </div>
            <div class="form-group">
                <label for="number_data14">對應概率/次數 (逗號分隔，數量需與數據值一致):</label>
                <input type="text" id="number_data14" name="number_data" required>
                <div class="form-note">
                    例如: 數據值=1,2,3  概率=0.2,0.5,0.3 或 次數=2,5,3
                </div>
            </div>
            <button type="button" onclick="submitForm(14)">計算</button>
            <button type="button" class="back-btn" onclick="backToMenu()">返回功能列表</button>
        </div>

        <!-- 計算結果區域 -->
        <div class="result-area" id="resultArea"></div>
    </div>

    <script>
        // 全域變量
        let currentChoice = 0;

        // 頁面加載完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 綁定功能列表點擊事件
            const functionItems = document.querySelectorAll('.function-list li');
            functionItems.forEach(item => {
                item.addEventListener('click', function() {
                    const choice = this.getAttribute('data-choice');
                    showForm(choice);
                });
            });

            // 初始化常態分布表單
            toggleNormalType();

            // 初始化梯形法則輸入框
            toggleTrapezoidInput();

            // 初始化H輸入框
            toggleHInput();
        });

        // 顯示對應功能表單
        function showForm(choice) {
            currentChoice = choice;

            // 隱藏所有表單
            const allForms = document.querySelectorAll('.input-form');
            allForms.forEach(form => {
                form.classList.remove('active');
            });

            // 顯示選擇的表單
            const targetForm = document.getElementById(`form${choice}`);
            if (targetForm) {
                targetForm.classList.add('active');
            }

            // 清空結果區域
            document.getElementById('resultArea').innerHTML = '';
            document.getElementById('resultArea').className = 'result-area';
        }

        // 返回功能列表
        function backToMenu() {
            const allForms = document.querySelectorAll('.input-form');
            allForms.forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById('resultArea').innerHTML = '';
            document.getElementById('resultArea').className = 'result-area';
        }

        // 切換常態分布正向/反向輸入框
        function toggleNormalType() {
            const choices = document.getElementById('choices6');
            const forwardSection = document.getElementById('normalForward');
            const reverseSection = document.getElementById('normalReverse');

            if (choices.value === '0') {
                forwardSection.style.display = 'block';
                reverseSection.style.display = 'none';
            } else {
                forwardSection.style.display = 'none';
                reverseSection.style.display = 'block';
            }
        }

        // 切換梯形法則輸入框
        function toggleTrapezoidInput() {
            const choice = document.getElementById('Choice9').value;
            const trapezoidInput = document.getElementById('trapezoidInput');

            if (choice === 'y') {
                trapezoidInput.style.display = 'block';
            } else {
                trapezoidInput.style.display = 'none';
            }
        }

        // 切換H輸入框顯示/隱藏
        function toggleHInput() {
            const AInput = document.getElementById('A8');
            const BInput = document.getElementById('B8');
            const HGroup = document.getElementById('H8Group');

            if (!AInput || !BInput) return; // 未加載form8時直接返回

            const A = parseFloat(AInput.value) || 0;
            const B = parseFloat(BInput.value) || 0;

            // 只有A=0且B=0（直線模式）時顯示H輸入框
            if (Math.abs(A) < 1e-9 && Math.abs(B) < 1e-9) {
                HGroup.style.display = 'block';
                // 顯示時添加required屬性
                document.getElementById('H8').required = true;
            } else {
                HGroup.style.display = 'none';
                // 隱藏時移除required屬性（避免表單驗證失敗）
                const HInput = document.getElementById('H8');
                HInput.required = false;
                HInput.value = '';
            }
        }

        // 提交表單數據
        function submitForm(choice) {
            try {
                // 獲取當前表單的所有輸入元素
                const form = document.getElementById(`form${choice}`);
                const inputs = form.querySelectorAll('input, select, textarea');

                // 構建表單數據
                const formData = new FormData();
                formData.append('choice', choice);

                // 收集所有輸入值
                inputs.forEach(input => {
                    if (input.name && input.name !== '') {
                        // 只收集可見的輸入框或有值的選填項
                        if ((input.style.display !== 'none') || (input.value && input.value.trim() !== '')) {
                            formData.append(input.name, input.value.trim());
                        }
                    }
                });

                // 特殊處理：更新自定義函數（積分/微分/化簡功能）
                if ([9, 12, 13].includes(parseInt(choice))) {
                    const funcInput = form.querySelector('textarea[name="func"]');
                    if (funcInput) {
                        formData.append('custom_func', funcInput.value.trim());
                    }
                }

                // 發送請求
                fetch('/calculate', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) throw new Error('伺服器回應錯誤');
                    return response.json();
                })
                .then(data => {
                    const resultArea = document.getElementById('resultArea');

                    if (data.status === 'success') {
                        resultArea.textContent = data.result;
                        resultArea.className = 'result-area success';
                    } else {
                        resultArea.textContent = `計算出錯: ${data.message}`;
                        resultArea.className = 'result-area error';
                    }
                })
                .catch(error => {
                    const resultArea = document.getElementById('resultArea');
                    resultArea.textContent = `網絡/伺服器錯誤: ${error.message}`;
                    resultArea.className = 'result-area error';
                });

            } catch (error) {
                const resultArea = document.getElementById('resultArea');
                resultArea.textContent = `表單驗證錯誤: ${error.message}`;
                resultArea.className = 'result-area error';
            }
        }
    </script>
</body>
</html>